{% extends base %}

{% block header %}

<style>
  .progress-circle {
    position: relative;
    display: inline-block;
    margin: 1rem;
  }

  .progress-circle svg {
    transform: rotate(-90deg);
  }

  .progress-circle circle {
    fill: none;
    stroke-linecap: round;
  }

  .progress-circle .progress-bar-bg {
    stroke: var(--bs-light, #f8f9fa);
  }

  .progress-circle .progress-bar {
    stroke: var(--primary, #0d6efd);
    transition: stroke-dashoffset 0.7s ease;
  }

  .progress-circle .progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5rem;
    font-weight: bold;
  }

  /* 颜色变体 */
  .progress-circle.primary .progress-bar {
    stroke: var(--bs-primary, #0d6efd);
  }

  .progress-circle.success .progress-bar {
    stroke: var(--bs-success, #198754);
  }

  .progress-circle.danger .progress-bar {
    stroke: var(--bs-danger, #dc3545);
  }

  .progress-circle.warning .progress-bar {
    stroke: var(--bs-warning, #ffc107);
  }

  .progress-circle.info .progress-bar {
    stroke: var(--bs-info, #0dcaf0);
  }

  /* 尺寸变体 */
  .progress-circle.sm {
    width: 80px;
    height: 80px;
  }

  .progress-circle.sm .progress-text {
    font-size: 1rem;
  }

  .progress-circle.lg {
    width: 150px;
    height: 150px;
  }

  .progress-circle.lg .progress-text {
    font-size: 2rem;
  }
</style>

{% endblock header %}



{% block body %}

<h3 style="text-align: center;">节点状态</h3>
<ul class="list-group list-group-flush">
  {% for node_id, node in admin_status.nodes.items() %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    {% if node.online %}
    <div>
      <span class="ms-2">{{ node.nickname }} ({{ node_id }})</span>
      <small class="text-muted d-block">
        <span class="badge bg-info">{{ node.adapter_name }}</span>
        {{ node.user_id }}
      </small>
    </div>
    <span class="badge badge-success">在线</span>
    {% else %}
    <div>
      <span class="ms-2">Moonlark ({{ node_id }})</span>
    </div>
    <span class="badge badge-danger">离线</span>
    {% endif %}
  </li>
  {% endfor %}
</ul>

<hr>

<h3 style="text-align: center;">系统资源</h3>



<div style="text-align: center" class="row">
  <div class="col-6">
    <h5>负载</h5>
    <div class="progress-circle info lg">
        <svg width="120" height="120" viewBox="0 0 120 120">
            <circle class="progress-bar-bg" cx="60" cy="60" r="54" stroke-width="8"></circle>
            <circle class="progress-bar" id="loadavg" cx="60" cy="60" r="54" stroke-width="8" stroke-dasharray="339.292" stroke-dashoffset="0"></circle>
        </svg>
        <div class="progress-text">{{ system.loadavg }}</div>
    </div>
  </div>
  <div class="col-3">
    <h5>CPU</h5>
    <div class="progress-circle info sm">
        <svg width="120" height="120" viewBox="0 0 120 120">
            <circle class="progress-bar-bg" cx="60" cy="60" r="54" stroke-width="8"></circle>
            <circle class="progress-bar" id="cpu" cx="60" cy="60" r="54" stroke-width="8" stroke-dasharray="339.292" stroke-dashoffset="0"></circle>
        </svg>
        <div class="progress-text">{{ system.cpu.usage }}%</div>
    </div>
    <small class="text-muted">{{ system.cpu.name }}</small>
    <br>
    <small class="text-muted">频率: {{ system.cpu.freq }}GHz</small>
  </div>
  <div class="col-3">
    <h5>物理内存</h5>
    <div class="progress-circle info sm">
        <svg width="120" height="120" viewBox="0 0 120 120">
            <circle class="progress-bar-bg" cx="60" cy="60" r="54" stroke-width="8"></circle>
            <circle class="progress-bar" id="memory" cx="60" cy="60" r="54" stroke-width="8" stroke-dasharray="339.292" stroke-dashoffset="0"></circle>
        </svg>
        <div class="progress-text">{{ system.mem.used }}GB</div>
    </div>
    <small class="text-muted">总 {{ system.mem.total }}GB</small>
    <br>
    <small class="text-muted">虚拟 {{ system.swap.used }}/{{ system.swap.total }}GB</small>
  </div>
  
</div>





<div class="row">
  <div class="col-4">开机时间: <span id="system_uptime"></span></div>
  <div class="col-4">运行时间: <span id="nb_uptime"></span></div>
  <div class="col-4">插件: <span id="loaded_plugin_count"></span></div>

</div>

<script>

  function parseTime(t) {
    const hours = parseInt(t / 3600);
    const mins = parseInt((t - hours * 3600) / 60);
    const secs = parseInt(t - hours * 3600 - mins * 60);
    return `${hours}:${mins}:${secs}`;
  }

  const pluginCount = {{ admin_status.plugins | json }}.length;

  document.getElementById("system_uptime").innerHTML = parseTime({{ system.uptime }});
  document.getElementById("nb_uptime").innerHTML = parseTime({{ system.nb_uptime }});

  const circumference = 108 * Math.PI;
  function updateProgress(progressBarId, percent) {
    const progressBar = document.getElementById(progressBarId);
    const offset = circumference - (percent / 100) * circumference;
    progressBar.style.strokeDashoffset = offset;
    progressBar.style.strokeDasharray = `${circumference}`;
  }

  updateProgress("loadavg", Math.max(parseInt({{ system.loadavg }} * 100)), 100);
  updateProgress("memory", Math.max(parseInt({{ system.mem.used }} / {{ system.mem.total }} * 100)), 100);
  updateProgress("cpu", parseInt({{ system.cpu.usage }} / {{ system.cpu.core_count }} * 100));
  
            



</script>

{% endblock body %}